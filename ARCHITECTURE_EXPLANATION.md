# Architecture Explanation

The cloud V1 is where the Crownstone cloud began. It contains a lot of legacy code. It is written in Javascript and based on Loopback 3.

Loopback 3 is very opinionated. It generates REST endpoints automatically based on the model definitions. As the cloud v1 grew, many default endpoints
have been manually disabled by these commands:

```
model.disableRemoteMethodByName(***)
```

Custom endpoints have been added and the project grew and grew. We have decided to stop active development of the cloudV1 and to add
new features to the cloud V2, based on Loopback 4.

There is documentation available on the following subjects:

- [Introduction](/docs/README.md)
- [Getting started](/docs/GETTING_STARTED.md)
- [Authorization](/docs/AUTHORIZATION.md)
  - [OAUTH](/docs/AUTHORIZATION.md)
- [Data hierarchy](/docs/DATA_HIERARCHY.md)
- [REST](/docs/REST.md)

# Project structure

There are two main folders that contain all the relevant logic. These are:

- **server**
  - This contains the entrypoint of the cloud (server.js), the configuration, and all the code that is not directly model defintions & endpoint handling
  - **/server/modules**
    - Contains logic modules for Events, Push notifications, SSE & webhooks.
- **common/models**
  - Contains all models as .json definitions, and the accompanying (optional) js files which configure the REST controllers away from the default behaviour.


# Configuration

Config of the cloud V1 is done by 4 files (or file groups).

- config.json
- datasources.json
- middleware.json
- model-config.json

All these provide default configurations, which are overwritten by the `<name>.local/production.js/json` (ie. config.local.json and datasources.production.js) files. Based on the environmental variable NODE_ENV,
the production or local version is used. This done to be able to easily have different configs in production and development.

All the .local.* files have not been committed to git.

You can use json or js, whatever you prefer for these. This is not possible for the base config file, which must be json.

# Where to start?

Read the documentation on loopback 3 to get a general gist of how it works. Most of the structure is due to loopback 3.

If you want to look at a certain endpoint, you look for the controller it is in (ie. user, Stone, Sphere, ..). Say we want to look at something in the stone controller, open the Stone.json and Stone.js files from /common/modules.

If the method is defined as a custom remote method by
```
model.remoteMethod('addBehaviour', {http: {path: '/:id/behaviours', verb: 'post'}, ...})
```
You can lookup the implementation on model.addBehaviour. If it does not have a remoteMethod defintion, it is automatically generated by Loopback based on the model json and
the ACL permission structure defined at the top of the model.

# What are webhooks?

This is a way of updating an external URL when data has changed. This has been superseded by the SSE based webhook server, but some of our users might still use the legacy version.
This is no longer maintained.
